<html>
<head>
<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="../general_functions.js"></script>
<script>
var huehost = "";
var hueuser = "";
var huelights = {};

function gethost() {
	var to_return = { "hueid": "", "huehost": ""};
	$.ajax({
		url: "https://discovery.meethue.com/",
		type: "GET",
		async: false,
		success: function (json) {
			console.log(json);
			if (json.length == 1 && "internalipaddress" in json[0]) {
				hueaddress = json[0]["internalipaddress"];
				hueid = json[0]["id"];
				document.getElementById("hueaddress").innerHTML = "Hub found at "+hueaddress;
				huehost = "https://"+hueaddress;
				to_return = { "hueid": hueid, "huehost": huehost};
			} else {
				document.getElementById("hueaddress").innerHTML = "Hub not found";
			}
		}
	})
	return to_return;
}

function getuser() {
	if (huehost == "") {
		document.getElementById("hueaddress").innerHTML = "No Hue hub found";
		return;
	}
	console.log("getting user");
	$.ajax({
		url: huehost+"/api",
		type: "POST",
		data: JSON.stringify({"devicetype":"my_hue_app#iphone peter"}),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json)
			if ("success" in json[0]) {
				hueuser = json[0]["success"]["username"];
				document.getElementById("hueuser").value = hueuser;
				setCookie("hueuser", hueuser, 365*24);
			}
			if ("error" in json[0] && json[0]["error"]["type"] == 101) {
				document.getElementById("hueuser").value = "Press Hub button and try again";
			}
		}
	})
}

function getinfo() {
	if (huehost == "") {
		document.getElementById("hueaddress").innerHTML = "No hue hub found";
		return;
	}
	if (hueuser == "") {
		document.getElementById("hueuser").value = "Press Hub button then Get User";
		return;
	}
	console.log("getting info");
	$.ajax({
		url: huehost+"/api/"+hueuser+"/lights",
		type: "GET",
		async: false,
		success: function (json) {
			huelights = json;
			console.log(huelights);		
			redraw_devices(huelights);
		}
	})
}

function redraw_devices(huelights) {
	var switches = document.getElementById("switches");
	switches.innerHTML = "";
	var tbl = document.createElement("table");
	var tbdy = document.createElement("tbody");
	for (light in huelights) {
		console.log(light);
		light_on = huelights[light]["state"]["on"];
		reachable = huelights[light]["state"]["reachable"];
		var tr = document.createElement("tr");
		var td = document.createElement("td");
		var light_name = huelights[light]["name"];
		var text = document.createTextNode(light_name);
		td.appendChild(text);
		tr.appendChild(td);
		var td1 = document.createElement("td");
		var but = document.createElement("button");
		but.innerHTML = "Off";
		but.onclick = function () { off(this) };
		but.id = "off_"+light;
		if ( (!reachable) || (!light_on) ) { but.classList.add("ui-disabled") };
		td1.appendChild(but);
		tr.appendChild(td1);
		var td2 = document.createElement("td");
		var but2 = document.createElement("button");
		but2.innerHTML = "On";
		but2.onclick = function () { on(this) };
		but2.id = "on_"+light;
		if ( (!reachable) || light_on ) { but2.classList.add("ui-disabled") };
		td2.appendChild(but2);
		tr.appendChild(td2);
		if ( "bri" in huelights[light]["state"] ) {
			var td3 = document.createElement("td");
			var inp = document.createElement("input");
			inp.type = "range";
			inp.min = 1;
			inp.max = 254;
			inp.value = huelights[light]["state"]["bri"];
			inp.onchange = function () { slider(this) };
			inp.id = "slider_"+light;
			if ( (!reachable) || (!light_on) ) { inp.classList.add("ui-disabled") };
			td3.appendChild(inp);
			tr.appendChild(td3);
		}
		tbdy.appendChild(tr);
	}
	tbl.appendChild(tbdy);
	switches.appendChild(tbl);
}

function on(element) {
	light = element.id.replace("on_", "");
	if (huehost == "") {
		document.getElementById("hueaddress").innerHTML = "No hue hub found";
		return;
	}
	if (hueuser == "") {
		document.getElementById("hueuser").value = "Press Hub button then Get User";
		return;
	}
	$.ajax({
		url: huehost+"/api/"+hueuser+"/lights/"+light+"/state",
		type: "PUT",
		data: JSON.stringify({"on": true}),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json);
		}
	})
	getinfo();
}

function off(element) {
	light = element.id.replace("off_", "");
	if (huehost == "") {
		document.getElementById("hueaddress").innerHTML = "No hue hub found";
		return;
	}
	if (hueuser == "") {
		document.getElementById("hueuser").value = "Press Hub button then Get User";
		return;
	}
	$.ajax({
		url: huehost+"/api/"+hueuser+"/lights/"+light+"/state",
		type: "PUT",
		data: JSON.stringify({"on": false}),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json);
		}
	})
	getinfo();
}


function slider(element) {
	light = element.id.replace("slider_", "");
	val = element.value;
	if (huehost == "") {
		document.getElementById("hueaddress").innerHTML = "No hue hub found";
		return;
	}
	if (hueuser == "") {
		document.getElementById("hueuser").value = "Press Hub button then Get User";
		return;
	}
	var data = {"bri": parseInt(val)}
	console.log(data);
	$.ajax({
		url: huehost+"/api/"+hueuser+"/lights/"+light+"/state",
		type: "PUT",
		data: JSON.stringify(data),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json);
		}
	})
	getinfo();
}

window.onload = function() {
	user_info = gethost();
	prev_id = getCookie("hueid");
	if (prev_id == user_info["hueid"]) {
		hueuser = getCookie("hueuser");
		if (hueuser != "") {
			document.getElementById("hueuser").value = hueuser;
		}
	} else if (user_info["hue_id"] == "") {
		document.getElementById("hueaddress").innerHTML = "Hub not found";
	} else {
		setCookie("hueid", user_info["hueid"], 365*24);
		getuser();
	}
}

$( document ).ajaxError(function( event, jqxhr, settings, thrownError ) {
	console.log(jqxhr["statusText"]);
	if (jqxhr["statusText"].includes("NetworkError: Failed to execute 'send' on 'XMLHttpRequest'")) {
		someHTML = "<br />Click this <a href='"+huehost+"'>link</a>, then click the Advanced button,"
		someHTML += " then click \"Proceed to "+huehost+" (unsafe)\"<br /><br />";
		document.getElementById("httpswarning").innerHTML = someHTML;
	} else {
		console.log(jqxhr["statusText"]);
	}
});

</script>
</head>
<body>
<div id="hueaddress">Searching for hub...</div>
<br /><br />
Hue user: <input type="text" id="hueuser" value="Press Hub button then Get User">
<button onclick="getuser()">Get User</button>
<div id="httpswarning">
<br /><br /></div>
<button onclick="getinfo()">Get Info</button>
<br /><br />
<div id="switches"></div>

<br /><br />
</body>
</html>
