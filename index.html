<html>
<head>

<link rel="stylesheet" href="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
<link rel="stylesheet" type="text/css" href="../styles.css">

<script src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
<script src="../general_functions.js"></script>
<script>
var huelights = {};
var user_info = {};

function gethost() {
	var to_return = { "hueid": "", "huehost": ""};
	$.ajax({
		url: "https://discovery.meethue.com/",
		type: "GET",
		async: false,
		success: function (json) {
			console.log(json);
			if (json.length == 1 && "internalipaddress" in json[0]) {
				hueaddress = json[0]["internalipaddress"];
				hueid = json[0]["id"];
				document.getElementById("hueaddress").innerHTML = "Hub found at "+hueaddress;
				huehost = "https://"+hueaddress;
				to_return = { "hueid": hueid, "huehost": huehost};
			} else {
				document.getElementById("hueaddress").innerHTML = "Hub not found";
			}
		}
	})
	return to_return;
}

function request_user(tries) {
	console.log(tries);
	$.ajax({
		url: user_info["huehost"]+"/api",
		type: "POST",
		data: JSON.stringify({"devicetype":"my_hue_app#iphone peter"}),
		dataType: "json",
		async: false,
		success: function (json) {
			if ("success" in json[0]) {
				user_info["hueuser"] = json[0]["success"]["username"];
			}
			if ("error" in json[0] && json[0]["error"]["type"] == 101) {
				document.getElementById("hueuser").innerHTML = "Press the button on your Hue hub to authenticate...";
			}
		}
	})
	if (user_info["hueuser"] != "") {
		document.getElementById("hueuser").innerHTML = "Hub authenticated!";
		setCookie("hueuser", user_info["hueuser"], 365*24);
		getinfo();
	}
	maxTries = 10;
	if (tries >= maxTries) {
		document.getElementById("hueuser").innerHTML = "Hub not authenticated";
		document.getElementById("getuser").classList.remove("hidden");
	}
	if (user_info["hueuser"] == "" && tries < maxTries) {
		setTimeout(request_user, 3000, tries+1);
	}
}

function getuser() {
	document.getElementById("getuser").classList.add("hidden");
	if (user_info["huehost"] == "") {
		document.getElementById("hueaddress").innerHTML = "No Hue hub found";
		return;
	}
	user_info["hueuser"] = getCookie("hueuser");
	if (user_info["hueuser"] != "") {
		document.getElementById("hueuser").innerHTML = "Hub authenticated";
		getinfo();
		return;
	}
	console.log("getting user");
	if (user_info["hueuser"] == "") {
		request_user(0);
	}
	return;
}

function getinfo() {
	console.log("getting info");
	$.ajax({
		url: user_info["huehost"]+"/api/"+user_info["hueuser"]+"/lights",
		type: "GET",
		async: false,
		success: function (json) {
			huelights = json;
			console.log(huelights);
			redraw_devices(huelights);
		}
	})
}

function redraw_devices(huelights) {
	var switches = document.getElementById("switches");
	switches.innerHTML = "";
	var tbl = document.createElement("table");
	var tbdy = document.createElement("tbody");
	for (light in huelights) {
		console.log(light);
		light_on = huelights[light]["state"]["on"];
		reachable = huelights[light]["state"]["reachable"];
		var tr = document.createElement("tr");
		var td = document.createElement("td");
		var light_name = huelights[light]["name"];
		var text = document.createTextNode(light_name);
		td.appendChild(text);
		tr.appendChild(td);
		var td1 = document.createElement("td");
		var but = document.createElement("button");
		but.innerHTML = "Off";
		but.onclick = function () { off(this) };
		but.id = "off_"+light;
		if ( (!reachable) || (!light_on) ) { but.classList.add("ui-disabled") };
		td1.appendChild(but);
		tr.appendChild(td1);
		var td2 = document.createElement("td");
		var but2 = document.createElement("button");
		but2.innerHTML = "On";
		but2.onclick = function () { on(this) };
		but2.id = "on_"+light;
		if ( (!reachable) || light_on ) { but2.classList.add("ui-disabled") };
		td2.appendChild(but2);
		tr.appendChild(td2);
		if ( "bri" in huelights[light]["state"] ) {
			var td3 = document.createElement("td");
			var inp = document.createElement("input");
			inp.type = "range";
			inp.min = 1;
			inp.max = 254;
			inp.value = huelights[light]["state"]["bri"];
			inp.onchange = function () { slider(this) };
			inp.id = "slider_"+light;
			if ( (!reachable) || (!light_on) ) { inp.classList.add("ui-disabled") };
			td3.appendChild(inp);
			tr.appendChild(td3);
		}
		tbdy.appendChild(tr);
	}
	tbl.appendChild(tbdy);
	switches.appendChild(tbl);
}

function on(element) {
	light = element.id.replace("on_", "");
	$.ajax({
		url: user_info["huehost"]+"/api/"+user_info["hueuser"]+"/lights/"+light+"/state",
		type: "PUT",
		data: JSON.stringify({"on": true}),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json);
		}
	})
	getinfo();
}

function off(element) {
	light = element.id.replace("off_", "");
	$.ajax({
		url: user_info["huehost"]+"/api/"+user_info["hueuser"]+"/lights/"+light+"/state",
		type: "PUT",
		data: JSON.stringify({"on": false}),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json);
		}
	})
	getinfo();
}


function slider(element) {
	light = element.id.replace("slider_", "");
	val = element.value;
	var data = {"bri": parseInt(val)}
	console.log(data);
	$.ajax({
		url: user_info["huehost"]+"/api/"+user_info["hueuser"]+"/lights/"+light+"/state",
		type: "PUT",
		data: JSON.stringify(data),
		dataType: "json",
		async: false,
		success: function (json) {
			console.log(json);
		}
	})
	getinfo();
}

window.onload = function() {
	user_info = gethost();
	prev_id = getCookie("hueid");
	if (prev_id == user_info["hueid"]) {
		getuser();
	} else if (user_info["hueid"] == "") {
		document.getElementById("hueaddress").innerHTML = "Hub not found";
	} else {
		setCookie("hueid", user_info["hueid"], 365*24);
		getuser();
	}
}

$( document ).ajaxError(function( event, jqxhr, settings, thrownError ) {
	console.log(jqxhr["statusText"]);
	if (jqxhr["statusText"].includes("NetworkError: Failed to execute 'send' on 'XMLHttpRequest'")) {
		proceedHTML = "<br />Click this <a href='"+user_info["huehost"]+"' target='_blank'>link</a>, then click the Advanced button,"
		proceedHTML += " then click \"Proceed to "+user_info["huehost"]+" (unsafe)\"<br /><br />";
		document.getElementById("httpswarning").innerHTML = proceedHTML;
	} else {
		console.log(jqxhr["statusText"]);
	}
});

</script>
</head>
<body>
<div id="hueaddress">Searching for hub...</div>
<br /><br />
<div id="hueuser"></div>
<button onclick="getuser()" id="getuser" class="hidden">Retry</button>
<div id="httpswarning">
<br /><br /></div>
<div id="switches"></div>

<br /><br />
</body>
</html>
